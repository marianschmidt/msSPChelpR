---
title: "Introduction to the msSPChelpR package - from long dataset to SIR analyses"
author: "Marian Eberl"
date: "13 May 2020"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to the msSPChelpR package - from long dataset to SIR analyses}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r , include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(msSPChelpR)
```

# Introduction

This vignette explains how to use the functions:

 * `pat_status` to determine patient status at end of follow-up
 * `vital_status` to determine vital status whether patient is alive or dead at end of follow-up
 * `calc_futime` to calculate follow-up time from index event until next event, death or end of follow-up date

# Recommended Workflows

## Calculate follow-up times {#wf-calc-fu}

It is recommended to run the following steps in the correct order to obtain accurate follow-up time calculations

 1. [Use the long version dataset](#step-long) to [filter all cases](#step-filter) that are relevant for your analysis. Make sure that: 
 
   * for each `case_id` the index event (e.g. First Cancer FC) is still included and is the one remaining row in the dataset with the smallest `case_id` (`TUMID3` variable for ZfKD data, and `SEQ_NUM` for SEER data)
   * all `case_id`s might or might not get a countable incident event (e.g. Second Primary Cancer SPC). This event should be the second entry per `case_id` (second smallest `case_id`) if it is to be counted
   * in the long version dataset a `count_var` should indicate whether the countable incident event (SPC) has occured or not. Coded `0` for non-occurence (or not counted event) and `1` for a counted incident event.
   
 2. [Renumber filtered long dataset](#step-renumber): In the filter long dataset, you should run the helper function `msSPChelpR::renumber_time_id_dt()` (or non-data.table variant `msSPChelpR::renumber_time_id()`) that will renumber all events per `case_id` and (if step 1 is fulfilled) will assign each index event with `time_var_new = 1` and each second (possibly countable incidenct event) with `time_var_new = 2`. Any SIR related function will only count the second event, if additionally to `time_var_new = 2` for this row also `count_var = 1` is true.
 
 3. [Reshape dataset](#step-reshape-wide): Run  `msSPChelpR::reshape_wide_dt()` or non-data.table-variant `msSPChelpR::reshape_wide()`, so that datset is transposed to wide format (1 row per `case_id`, creating variables such as `count_var.2`).
 
 4. [Set flag for Second Primary Cancer diagnosis](#step-spc): After filtering and reshaping it is essential to set `p_spc` again. This variable will be used by later steps of the analysis.
 
 5. [Determine patient status](#step-pat-status) at a defined end of follow-up by using the `msSPChelpR::pat_status()` function. This date for end of follow-up must:
   * be in "YYYY-MM-DD" format and is always defined via the `fu_end =` parameter
   * must preceed the end of data collection. E.g. if the last incident events for the dataset you are using are collected at the end of 2014, your `fu_end` must be `fu_end = "2014-12-15"` or earlier.
   
 6. [Calculate follow-up time](#step-calc-futime) for the same dataset by using the `msSPChelpR::calc_futime()` function and the same `fu_end` as for step 4. By standard all functions of the `msSPChelpR` package require follow-up times as numeric years.
 

## Calculate Standardized Incidence Ratios (SIR) 

In order to calculate SIR using the package functions, the following data structure is needed:
  * Wide format data `wide_df` with one row per patient that has encountered the index event (i.e. diagnosed with a first primary cancer FC)

 * The dataset `wide_df` needs to contain the following variables (columns) per patient (row):
   * `region_var` - variable in df that contains information on region where case was incident.
   * `agegroup_var` - variable in df that contains information on age-group.
   * `sex_var` - variable in df that contains information on biological sex.
   * `year_var` - variable in df that contains information on year or year-period when case was incident.
   * `icdcat_var` - variable in df that contains information on case (count event) diagnosis. Cases are usually the second cancers. Diagnoses can use any coding system (e.g. ICD) but coding system between dataset and reference data must be coherent.
   * `futime_var` - variable in df that contains follow-up time per person between date of first cancer and any of death, date of event (case), end of FU date (in years; whatever event comes first). In case you have not calculated the FU time yet, you can use the workflow described in the previous [chapter](#wf-calc-fu).
   
If your data has the required structure, you can calculate and summarize SIRs with the following two steps:

 7. [Calculate SIR](#step-sir-byfutime) per SPC diagnosis with age, sex, region, period-specific strata using the `msSPChelpR::sir_byfutime()` function. For this calculation usually a reference dataset is required that defines the population standard rates. `refpop_df` must use the same category coding of age, sex, region, year and icdcat as `agegroup_var`, `sex_var`, `region_var`, `year_var` and `icdcat_var`
   * The theory behind calculating stratified SIRs is explained in the chapter on [basics on SIRs](#theo-sir)
   
 8. [Summarize SIR results](#step-summarize-sir) using the `msSPChelpR::summarize_sir_results()` function on the stratified sir results produced by the previous step.


# Details on single functions

## `renumber_time_id()` function

## `reshape_wide()` function

## `reshape_long()` function

## `pat_status()` function

## `vital_status()` function

## `calc_futime()` function

## `sir_byfutime()` function

## `summarize_sir_results()` function



# Theory behind SIRs {#theo-sir}

# Examples

## SEER lung cancer

### Step 1 - Long dataset {#step-long}




### Step 2 - Filter long dataset {#step-filter}

### Step 3 - Renumber `time_id` {#step-renumber}

### Step 4 - Reshape to wide dataset {#step-reshape-wide}

### Step 5 - Recalculate `p_spc` {#step-spc}

```{r, echo=TRUE, eval=FALSE}

wide_sdata_lung <- wide_sdata_lung %>%
  dplyr::mutate(p_spc = case_when(is.na(PRIMSITE.2)     ~ 0,
                         !is.na(PRIMSITE.2)    ~ 1,
                         TRUE ~ NA_real_)) %>%
  sjlabelled::var_labels(p_spc="Patient has developed Second Primary Cancer") %>%
  sjlabelled::set_labels(p_spc, labels = c("no SPC" = 0,
                                           "SPC developed" = 1)) %>%
  dplyr::mutate(p_spc =  sjlabelled::as_label(p_spc, keep.labels=TRUE)) 

```

### Step 6 - Determine patient status at end of FU {#step-pat-status}

### Step 7 - Calculate FU time {#step-calc-futime}

### Step 8 - Calculate SIR {#step-sir-byfutime}

### Step 9 - Summarize SIR results {#step-summarize-sir}


## ZfKD melanoma

### Step 1 - Long dataset

### Step 2 - Filter long dataset

### Step 3 - Renumber `time_id`

### Step 4 - Reshape to wide dataset

### Step 5 - Determine patient status at end of FU

### Step 6 - Calculate FU time


## Built with

```{r}
sessionInfo()
```
